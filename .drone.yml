---
kind: pipeline
name: default

platform:
  os: linux
  arch: amd64

services:
- name: postgres
  image: postgres:11.1-alpine
  environment:
    POSTGRES_PASSWORD: password
    POSTGRES_USER: postgres
    POSTGRES_DB: client_hi_crm_testing

steps:
- name: build
  pull: if-not-exists
  image: davidianbonner/wercker-php-laravel
  environment:
    DB_HOST: postgres
    DB_DATABASE: client_hi_crm_testing
    ENV:
      from_secret: ENV
  commands:
    - php -v
    - node -v
    - chmod -R 777 storage
    - composer install
    - npm install
    - npm run production
    - cp .env.example .env
    - php artisan key:generate
    - php artisan migrate
    - php artisan db:seed

- name: codereview
  pull: if-not-exists
  image: davidianbonner/wercker-php-laravel
  depends_on:
  - build
  commands:
  - php vendor/squizlabs/php_codesniffer/bin/phpcs -p -d memory_limit=32M --extensions=php app
  - php artisan insights --no-interaction --min-quality=90 --min-complexity=85 --min-architecture=90 --min-style=95

- name: test
  pull: if-not-exists
  image: davidianbonner/wercker-php-laravel
  depends_on:
  - build
  environment:
    DB_HOST: postgres
    DB_DATABASE: client_hi_crm_testing
    ENV:
      from_secret: ENV
  commands:
  - php vendor/phpunit/phpunit/phpunit
